<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/gliaswap-docs/blog/rss.xml" title="Gliaswap Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/gliaswap-docs/blog/atom.xml" title="Gliaswap Blog Atom Feed"><title data-react-helmet="true">Info Cell Type Script | Gliaswap</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Info Cell Type Script | Gliaswap"><meta data-react-helmet="true" name="description" content="1. Rule 1 - TypeID rules"><meta data-react-helmet="true" property="og:description" content="1. Rule 1 - TypeID rules"><meta data-react-helmet="true" property="og:url" content="https://zoe-zhouzhou.github.io/gliaswap-docs/docs/tx-script-sudt/info-type-script"><link data-react-helmet="true" rel="shortcut icon" href="/gliaswap-docs/img/logo.svg"><link data-react-helmet="true" rel="canonical" href="https://zoe-zhouzhou.github.io/gliaswap-docs/docs/tx-script-sudt/info-type-script"><link rel="stylesheet" href="/gliaswap-docs/styles.066e4677.css">
<link rel="preload" href="/gliaswap-docs/styles.e14deca6.js" as="script">
<link rel="preload" href="/gliaswap-docs/runtime~main.67eb29e5.js" as="script">
<link rel="preload" href="/gliaswap-docs/main.0343998c.js" as="script">
<link rel="preload" href="/gliaswap-docs/1.dba57845.js" as="script">
<link rel="preload" href="/gliaswap-docs/2.aeef72c1.js" as="script">
<link rel="preload" href="/gliaswap-docs/46.04a79037.js" as="script">
<link rel="preload" href="/gliaswap-docs/47.2bc9e338.js" as="script">
<link rel="preload" href="/gliaswap-docs/935f2afb.4513c572.js" as="script">
<link rel="preload" href="/gliaswap-docs/17896441.3c886368.js" as="script">
<link rel="preload" href="/gliaswap-docs/b4ee9fde.7051d3cb.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/gliaswap-docs/"><img src="/gliaswap-docs/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/gliaswap-docs/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Gliaswap</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/gliaswap-docs/docs/">Docs</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/gliaswap" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/gliaswap-docs/"><img src="/gliaswap-docs/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/gliaswap-docs/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Gliaswap</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/gliaswap-docs/docs/">Docs</a></li><li class="menu__list-item"><a href="https://github.com/gliaswap" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_vMrn"><div class="docSidebarContainer_3Ak5" role="complementary"><div class="sidebar_3gvy"><div class="menu menu--responsive thin-scrollbar menu_1yIk"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_1CUI" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Start</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/gliaswap-docs/docs/">Introduction</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Run Gliaswap</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/gliaswap-docs/docs/run/run">Run Gliaswap</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist" href="#!">Product</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/gliaswap-docs/docs/product/overview">Gliaswap Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/gliaswap-docs/docs/product/fee">Fee Structure</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Protocol</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="0">Swap sUDT/CKB</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/gliaswap-docs/docs/tx-script/cell">Cell Structure</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Transaction Structure</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/gliaswap-docs/docs/tx-script/swap-tx">Swap</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/gliaswap-docs/docs/tx-script/pool-tx">Pool</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Script</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/gliaswap-docs/docs/tx-script/info-type-script">Info Cell Type Script</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/gliaswap-docs/docs/tx-script/info-lock-script">Info Cell Lock Script</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/gliaswap-docs/docs/tx-script/swap-lock-script">Swap Request Cell Lock Script</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/gliaswap-docs/docs/tx-script/liquidity-lock-script">Liquidity Request Cell Lock Script</a></li></ul></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!" tabindex="0">Swap sUDT/sUDT</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/gliaswap-docs/docs/tx-script-sudt/cell">Cell Structure</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist" href="#!" tabindex="0">Transaction Structure</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/gliaswap-docs/docs/tx-script-sudt/swap-tx">Swap</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/gliaswap-docs/docs/tx-script-sudt/pool-tx">Pool</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!" tabindex="0">Script</a><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/gliaswap-docs/docs/tx-script-sudt/info-type-script">Info Cell Type Script</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/gliaswap-docs/docs/tx-script-sudt/info-lock-script">Info Cell Lock Script</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/gliaswap-docs/docs/tx-script-sudt/swap-lock-script">Swap Request Cell Lock Script</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/gliaswap-docs/docs/tx-script-sudt/liquidity-lock-script">Liquidity Request Cell Lock Script</a></li></ul></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Reference</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/gliaswap-docs/docs/ref/faq">FAQ</a></li></ul></li></ul></div></div></div><main class="docMainContainer_2iGs"><div class="container padding-vert--lg docItemWrapper_1bxp"><div class="row"><div class="col docItemCol_U38p"><div class="docItemContainer_a7m4"><article><header><h1 class="docTitle_Oumm">Info Cell Type Script</h1></header><div class="markdown"><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="1-rule-1---typeid-rules"></a>1. Rule 1 - <a href="https://github.com/nervosnetwork/ckb/blob/master/script/src/type_id.rs" target="_blank" rel="noopener noreferrer">TypeID rules</a><a class="hash-link" href="#1-rule-1---typeid-rules" title="Direct link to heading">#</a></h4><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="2-rule-2---if-this-is-a-matching-transaction-the-cell-sequence-in-this-tx-should-follow-the-rules-blow"></a>2. Rule 2 - If this is a matching transaction, the cell sequence in this tx should follow the rules blow:<a class="hash-link" href="#2-rule-2---if-this-is-a-matching-transaction-the-cell-sequence-in-this-tx-should-follow-the-rules-blow" title="Direct link to heading">#</a></h4><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-text codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">info_in_cell                            info_out_cell</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">pool_x_in_cell                          pool_x_out_cell</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">pool_y_in_cell                          pool_y_out_cell</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                          -------&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">matcher_in_cell                         matcher_out_ckb_cell</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[swap_request_cell]                     [sudt_swapped_cell</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                       + ckb_change_cell]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[ add_liquidity_x_cell                  [sudt_lp_cell</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">+ add_liquidity_y_cell                 + sudt_change_cell</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                       + ckb_change_cell]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[remove_liquidity_cell]                 [sudt_x_cell</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                       + sudt_y_cell]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="3-rule-3---intercept-the-swap-request-queue-from-inputs-and-outputs-and-for-each-request-cellï¼Œverifity-if-the-actual-pay-amount-and-receive-amount-satisfy-the-request-amount-in-swap-request-cell-and-update-the-sudt_x_reserve-and-sudt_y_reserve-for-following-verification"></a>3. Rule 3 - Intercept the swap request queue from inputs and outputs, and for each request cellï¼Œverifity if the actual pay amount and receive amount satisfy the request amount in swap request cell. And update the sudt_x_reserve and sudt_y_reserve for following verification.<a class="hash-link" href="#3-rule-3---intercept-the-swap-request-queue-from-inputs-and-outputs-and-for-each-request-cellï¼Œverifity-if-the-actual-pay-amount-and-receive-amount-satisfy-the-request-amount-in-swap-request-cell-and-update-the-sudt_x_reserve-and-sudt_y_reserve-for-following-verification" title="Direct link to heading">#</a></h4><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">let info = inputs[0]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let pool_x = inputs[1]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let pool_y = inputs[2]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let sudt_x_reserve = info_in.data.sudt_x_reserve</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let sudt_y_reserve = info_in.data.sudt_y_reserve</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">for (let i = 0, j = 0; i &lt; swap_inputs.length &amp;&amp; j &lt; swap_outputs.length; I = i + 1, j = j+ 2)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let req_sudt = swap_inputs[i]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let sudt_out = swap_outputs[j]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let ckb_change = swap_outputs[j + 1]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // ## Request input cell basic verification</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Leave capacity verification to ckb change cell below</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if req_sudt.data.size &lt; 16</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        || (req_sudt.type_hash != pool_x.type_hash &amp;&amp; req_sudt.type_hash != pool_y.type_hsh)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let sudt_out_type_hash = req_sudt.lock.args[0..32]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Swapped sudt not match</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (sudt_out_type_hash != pool_x.type_hash &amp;&amp; sudt_out_type_hash != pool_y.type_hash)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Swap self</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if sudt_out_type_hash == req_sudt.type_hash</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // ## Output cell basic verification</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let user_lock_hash = req_sudt.lock.args[32..64]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let tips_ckb = req_sudt.lock.args[81..89]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let tips_sudt = req_sudt.lock.args[90..105]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if sudt_out.capacity != MIN_SUDT_CAPACITY</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        || sudt_out.data.size &lt; 16</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        || sudt_out.type_hash != sudt_out_type_hash</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        || sudt_out.lock_hash != user_lock_hash</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if ckb_change.capacity != req_sudt.capacity - MIN_SUDT_CAPACITY - tips_ckb</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        || ckb_change.data.size != 0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        || ckb_change.type != none</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        || ckb_change.lock_hash != user_lock_hash</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // ## Swap price verification</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let amount_in = req_sudt.data.amount - tips_sudt</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let amount_out = sudt_out.data.amount</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let amount_out_min = req_sudt.lock.args[65..81]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if amount_out_min == 0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        || amount_out &lt; amount_out_min</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // sudt x =&gt; sudt y</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if sudt_out.type_hash == pool_y.type_hash</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        let numerator = 997 * sudt_y_reserve * amount_in</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        let denominator = sudt_x_reserve * 1000 + amount_in * 997</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if amount_out != (numerator / denominator) + 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        sudt_x_reserve = sudt_x_reserve + amount_in</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        sudt_y_reserve = sudt_y_reserve - amount_out</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    else</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        let numerator = 997 * sudt_x_reserve * amount_in</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        let denominator = sudt_y_reserve * 1000 + amount_in * 997</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if amount_out != (numerator / denominator) + 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        sudt_x_reserve = sudt_x_reserve - amount_out</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        sudt_y_reserve = sudt_y_reserve + amount_in</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    fi</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">endfor</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="4-rule-4---if-this-is-a-creating-pool-transaction-verify-that-two-pool-cells-is-created-at-the-same-time-as-the-info-cell-and-that-the-data-filled-in-info-cell-and-pool-cell-are-correct"></a>4. rule 4 - If this is a creating pool transaction, verify that two Pool cells is created at the same time as the Info cell, and that the data filled in info cell and pool cell are correct.<a class="hash-link" href="#4-rule-4---if-this-is-a-creating-pool-transaction-verify-that-two-pool-cells-is-created-at-the-same-time-as-the-info-cell-and-that-the-data-filled-in-info-cell-and-pool-cell-are-correct" title="Direct link to heading">#</a></h4><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// Info creation</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">if count(input.type.code_hash == INFO_TYPE_CODE_HASH) == 0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &amp;&amp; count(output.type.code_hash == INFO_TYPE_CODE_HASH) == 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // For type deployment, the output.lock.code_hash is info lock dep cell&#x27;s</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // type hash. So we must extract data hash from dep cell to be able to</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // verify it agains our hard code data hash, INFO_LOCK_CODE_HASH.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if not_find(any(cell_dep).type_hash == output.lock.code_hash)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let info_lock_data_hash = hash(info_lock_cell_dep.data)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let lock_count = count(info_lock_data_hash == INFO_LOCK_CODE_HASH)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if lock_count == 3 // sudt/sudt</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        let pool_x = outputs[1]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        let pool_y = outputs[2]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // Same sudt</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if pool_x.type_hash == pool_y.type_hash</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if info.lock.hash_type != 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            || info.lock.args[0..32] != hash(pool_x.type_hash | pool_y.type_hash)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            || info.lock.args[32..64] != info.type_hash</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if pool_x.capacity != POOL_BASE_CAPACITY</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            || pool_x.data.size &lt; 16</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            || pool_x.lock_hash != info.lock_hash</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            || pool_y.capacity != POOL_BASE_CAPACITY</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            || pool_y.data.size &lt; 16</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            || pool_y.lock_hash != pool_x.lock_hash</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    else</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">fi</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="5-rule-5---if-this-is-initially-adding-liquidity-verify-if-minting-the-correct-amount-liquidity-token-for-user-and-verify-if-the-data-storaged-in-info-cell-and-pool-cell-is-correct"></a>5. Rule 5 - If this is initially adding liquidity, verify if minting the correct amount Liquidity token for user, and verify if the data storaged in info cell and pool cell is correct.<a class="hash-link" href="#5-rule-5---if-this-is-initially-adding-liquidity-verify-if-minting-the-correct-amount-liquidity-token-for-user-and-verify-if-the-data-storaged-in-info-cell-and-pool-cell-is-correct" title="Direct link to heading">#</a></h4><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let info = inputs[0]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let pool_x = inputs[1]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let pool_y = inputs[2]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let sudt_x_reserve = swap_updated_sudt_x_reserve</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let sudt_y_reserve = swap_updated_sudt_y_reserve</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let total_liquidity = info_in.data.total_liquidity</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">fn verify_genesis_liquidity()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Wrong cell number</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if inputs.len() != 6 || outputs.len() != 6</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Not genesis</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if sudt_x_reserve != 0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        || sudt_y_reserve != 0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        || total_liquidity != 0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let req_sudt_x = inputs[4]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let req_sudt_y = inputs[5]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let sudt_lp = outputs[4]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let ckb_change = outputs[5]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // ## Request input cell basic verification</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Capacity verification is done by output ckb change cell below</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if req_sudt_x.data.size &lt; 16</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        || req_sudt_x.type_hash != pool_x.type_hash</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        || req_sudt_y.data.size &lt; 16</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        || req_sudt_y.type_hash != pool_y.type_hash</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Info cell not match</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if req_sudt_x.lock.args[0..32] != info.type_hash</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        || req_sudt_y.lock.args[0..32] != info.type_hash</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Req user lock hash not match</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let user_lock_hash = req_sudt_x.lock.args[32..64]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if req_sudt_y.lock.args[32..64] != user_lock_hash</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Req cell not match</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if req_sudt_y.lock.args[64..96] != req_sudt_x.lock_hash</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // ## Output cell basic verification</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let tips_ckb = req_sudt_x.lock.args[97..105]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let tips_sudt_x = req_sudt_x.lock.args[105..121]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let tips_sudt_y = req_sudt_x.lock.args[121..137]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if sudt_lp.capacity != MIN_SUDT_CAPACITY</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        || sudt_lp.data.size &lt; 16</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        || sudt_lp.type_hash != info.data.sudt_lp_type_hash</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        || sudt_lp.lock_hash != user_lock_hash</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        reutrn fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if ckb_change.capacity != req_sudt_x.capacity + req_sudt_y.capacity - MIN_SUDT_CAPACITY - tips_ckb</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        || ckb_change.data.size != 0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        || ckb_change.type != none</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        || ckb_change.lock_hash != user_lock_hash</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // ## Genesis liquidity price verification</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let amount_x_in = req_sudt_x.data.amount - tips_sudt_x</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let amount_y_in = req_sudt_y.data.amount - tips_sudt_y</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let amount_lp = sudt_lp.data.amount</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if amount_lp != (amount_x_in * amount_y_in).sqrt();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    sudt_x_reserve = amount_x_in</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    sudt_y_reserve = amount_y_in</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    total_liquidity = amount_lp</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">endfn</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><strong>6. rule 6 - Intercept the liquidity request queue from inputs and outputs, and for each request cellï¼Œverifity if the actual pay amount and receive amount satisfy the request amount in the request cell. And update the sudt_x_reserve and sudt_y_reserve for following verification.</strong></p><ul><li>If it is add liquidity request cell, verify if minting the correct amount Liquidity token for user, and add up the CKB amount, sUDT amount and Liquidity token amount for verifying info cell and pool cell later.</li><li>If it is remove liquidity request cell, verify if withdraw the correct CKB amount and sudt amount for user, update the CKB amount, sUDT amount and Liquidity token amount for verifying info cell and pool cell later.</li><li>Verify if the data changed in info cell and pool cell is correct </li></ul><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// verify add liquidity request</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">fn verify_add_liquidity()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Wait genesis liquidity</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if total_liquidity == 0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    for(let i = 0, j = 0; i &lt; add_inputs.length &amp;&amp; j &lt; add_inputs.length, i = i + 2, j = j + 3)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        let req_sudt_x = add_inputs[i]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        let req_sudt_y = add_inputs[i + 1]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        let sudt_lp = add_outputs[j]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        let sudt_change = add_outputs[j + 1]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        let ckb_change = add_outputs[j + 2]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // ## Request input cell basic verification</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // Capacity verification is done by output ckb change cell below</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if req_sudt_x.data.size &lt; 16</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            || req_sudt_x.type_hash != pool_x.type_hash</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            || req_sudt_y.data.size &lt; 16</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            || req_sudt_y.type_hash != pool_y.type_hash</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // info cell not match</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if req_sudt_x.lock_hash[0..32] != info.type_hash</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            || req_sudt_y.lock_hash[0..32] != info.type_hash</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // Req use lock hash not match</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        let user_lock_hash = req_sudt_x.lock.args[32..64]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if req_sudt_y.lock.args[32..64] != user_lock_hash</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // req cell not match</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if req_sudt_y.lock.args[64..96] != req_sudt_x.lock_hash</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // ## Output cell basic verification</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        let tips_ckb = req_sudt_x.lock.args[97..105]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        let tips_sudt_x = req_sudt_x.lock.args[105..121]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        let tips_sudt_y = req_sudt_y.lock.args[121..137]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if sudt_lp.capacity != MIN_SUDT_CAPACITY</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            || sudt_lp.data.size &lt; 16</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            || sudt_lp.type_hash != info.data.sudt_lp_type_hash</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            || sudt_lp.lock_hash != user_lock_hash</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            reutrn fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if sudt_change.capacity != MIN_SUDT_CAPACITY</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            || sudt_change.data.size &lt; 16</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            || (sudt_change.type_hash != req_sudt_x.type_hash &amp;&amp; sudt_change != req_sudt_y.type_hash)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            || sudt_change.lock_hash != user_lock_hash</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if ckb_change.capacity != req_sudt_x.capacity + req_sudt_y.capacity - 2 * MIN_SUDT_CAPACITY - tips_ckb</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            || ckb_change.data.size != 0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            || ckb_change.type != none</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            || ckb_change.lock_hash != user_lock_hash</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // ## Add liquidity price verification</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        let amount_x = req_sudt_x.data.amount - tips_sudt_x</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        let amount_y = req_sudt_y.data.amount - tips_sudt_y</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        let amount_x_min = req_sudt_x.lock.args[65..81]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        let amount_y_min = req_sudt_y.lock.args[81..97]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        let amount_change = sudt_change.data.amount</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        let amount_lp = sudt_lp.data.amount</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // Check sudt x exhaustion</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if sudt_change.type_hash == req_sudt_y.type_hash</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            let amount_y_in = amount_y - amount_change</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if amount_y_min == 0 || amount_y_in &lt; amount_y_min</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if amount_y_in != (amount_x * sudt_y_reserve / sudt_x_reserve) + 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if amount_lp != amount_x * total_liquidity / sudt_x_reserve + 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            sudt_x_reserve = sudt_x_reserve + amount_x</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            sudt_y_reserve = sudt_y_reserve + amount_y_in</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // Check sudt y exhaustion</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        else</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            let amount_x_in = amount_x - amount_change</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if amount_x_min == 0 || amount_x_in &lt; amount_x_min</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if amount_x_in != (amount_y * sudt_x_reserve / sudt_y_reserve) + 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if amount_lp != amount_y * total_liquidity / sudt_y_reserve + 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            sudt_x_reserve = sudt_x_reserve + amount_x_in</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            sudt_y_reserve = sudt_y_reserve + amount_y</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        fi</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        total_liquidity = total_liquidity + amount_lp</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    endfor</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">endfn</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">//verify remove liquidity request</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">fn verify_remove_liquidity()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Wait genesis liquidity</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if total_liquidity == 0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    for(let i = 0, j = 0; i &lt; remove_inputs.length &amp;&amp; j &lt; remove_inputs.length, i = i + 1, j = j + 2)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        let req_sudt_lp = remove_inputs[i]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        let sudt_x = remove_outputs[j]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        let sudt_y = remove_outputs[j + 1]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // ## Request input cell basic verification</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if req_sudt_lp.capacity &lt; MIN_SUDT_CAPACITY * 2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            || req_sudt_lp.data.size &lt; 16</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // info cell sudt type hash not match</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if req_sudt_lp.type_hash != info.data.sudt_lp_type_hash</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // info cell not match</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if req_sudt_lp.lock_hash[0..32] != info.type_hash</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // ## Output cell basic verification</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        let user_lock_hash = req_sudt_lp.lock.args[32..64]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        let tips_sudt_lp = req_sudt_lp.lock.args[105..121]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if sudt_x.capacity != MIN_SUDT_CAPACITY</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            || sudt_x.data.size &lt; 16</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            || sudt_x.type_hash != pool_x.type_hash</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            || sudt_x.lock_hash != user_lock_hash</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if sudt_y.capacity != MIN_SUDT_CAPACITY</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            || sudt_y.data.size &lt; 16</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            || sudt_y.type_hash != pool_y.type_hash</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            || sudt_y.lock_hash != user_lock_hash</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // ## Remove liquidity price verification</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        let amount_lp = req_sudt_lp.data.amount - tips_sudt_lp</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        let amount_x_out = sudt_x.data.amount</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        let amount_y_out = sudt_y.data.amount</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        let amount_x_out_min = sudt_x.lock.args[65..81]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        let amount_y_out_min = sudt_y.lock.args[81..97]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if amount_x_out_min == 0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            || amount_x_out &lt; amount_x_out_min</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if amount_y_out_min == 0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            || amount_y_out &lt; amount_y_out_min</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if amount_x_out != amount_lp * sudt_x_reserve / total_liquidity + 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if amount_y_out != amount_lp * sudt_y_reserve / total_liquidity + 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        sudt_x_reserve = sudt_x_reserve - amount_x_out</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        sudt_y_reserve = sudt_y_reserve - amount_y_out</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    endfor</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">endfn</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// Verify if the data changed in info cell and pool cell is correct </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">if info_creation?</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return info_creation_verification()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">fi</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let info_in = inputs[0]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let pool_x_in = inputs[1]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let pool_y_in = inputs[2]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let info_out = outputs[0]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let pool_x_out = outputs[1]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let pool_y_out = outputs[2]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// ## Input info, pool basic verification</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// Leave info type hash verification to outputs below</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">if info_in.capacity != INFO_CAPACITY</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    || info_in.data.size != 80</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    || info_in.data.sudt_x_reserve != pool_x_in.data.amount</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    || info_in.data.sudt_y_reserve != pool_y_in.data.amount</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    || info_in.lock.args[0..32] != hash(pool_x_in.type_hash | pool_y_in.type_hash)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    || info_in.lock.args[32..64] != info.type_hash</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// poox_x_in type hash is alredy verified above</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">if pool_x_in.capacity != POOL_CAPACITY</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    || pool_x_in.data.size &lt; 16</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    || pool_x_in.lock_hash != info_in.lock_hash</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// poox_y_in type hash is alredy verified above</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">if pool_y_in.capacity != POOL_CAPACITY</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    || pool_y_in.data.size &lt; 16</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    || pool_y_in.lock_hash != info_in.lock_hash</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// ## Output info, pool basic verification</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">if info_out.capacity != info_in.capacity</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    || info_out.data.size != info_out.data.size</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    || info_out.data.sudt_x_reserve != pool_x_out.data.amount</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    || info_out.data.sudt_y_reserve != pool_y_out.data.amount</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    || info_out.type_hash != info_in.type_hash</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    || info_out.lock_hash != info_out.lock_hash</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">if pool_x_out.capacity != pool_x_in.capacity</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    || pool_x_out.data.size != pool_x_in.data.size</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    || pool_x_out.type_hash != pool_x_in.type_hash</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    || pool_x_out.lock_hash != pool_x_in.lock_hash</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">if pool_y_out.capacity != pool_y_in.capacity</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    || pool_y_out.data.size != pool_y_in.data.size</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    || pool_y_out.type_hash != pool_y_in.type_hash</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    || pool_y_out.lock_hash != pool_y_in.lock_hash</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// ## Transaction verification</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let sudt_x_reserve = info_in.data.sudt_x_reserve</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let sudt_y_reserve = info_in.data.sudt_y_reserve</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let total_liquidity = info_in.data.total_liquidity</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let swap_size = WitnessArgs.type_input.swap_size</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let add_liquidity_size = WitnessArgs.type_input.add_liquidity_size</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let swap_inputs = inputs[4..4 + swap_size]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let swap_outputs = outputs[4..4 + swap_size * 2]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">do_swap_verification(swap_inputs, swap_outputs, sudt_x_reserve, sudt_y_reserve)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let add_inputs = inputs[4 + swap_size..4 + swap_size + add_size * 2]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let add_ouputs = outpus[4 + swap_size * 2.. 4 + swap_size * 2 + add_size * 3]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">do_add_liquidity_verification(add_inputs, add_ouputs, sudt_x_reserve, sudt_y_reserve, total_liquidity)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let remove_inputs = inputs[4 + swap_size + add_size * 2..]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let remove_ouputs = outputs[4 + swap_size * 2 + add_size * 3..]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">do_remove_liquidity_verification(remove_inputs, remove_outputs, sudt_x_reserve, sudt_y_reserve, total_liquidity)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">if sudt_x_reserve != info_out.data.sudt_x_reserve</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    || sudt_y_reserve != info_out.data.sudt_y_reserve</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    || total_liquidity != info_out.data.total_liquidity</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return fail</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/facebook/docusaurus/edit/master/website/docs/tx-script-sudt/info-type-script.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2LL7"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/gliaswap-docs/docs/tx-script-sudt/pool-tx"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Pool transaction structure</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/gliaswap-docs/docs/tx-script-sudt/info-lock-script"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Info Cell Lock Script Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_2xL- thin-scrollbar"></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 GliaTeam.</div></div></div></footer></div>
<script src="/gliaswap-docs/styles.e14deca6.js"></script>
<script src="/gliaswap-docs/runtime~main.67eb29e5.js"></script>
<script src="/gliaswap-docs/main.0343998c.js"></script>
<script src="/gliaswap-docs/1.dba57845.js"></script>
<script src="/gliaswap-docs/2.aeef72c1.js"></script>
<script src="/gliaswap-docs/46.04a79037.js"></script>
<script src="/gliaswap-docs/47.2bc9e338.js"></script>
<script src="/gliaswap-docs/935f2afb.4513c572.js"></script>
<script src="/gliaswap-docs/17896441.3c886368.js"></script>
<script src="/gliaswap-docs/b4ee9fde.7051d3cb.js"></script>
</body>
</html>