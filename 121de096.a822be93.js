(window.webpackJsonp=window.webpackJsonp||[]).push([[6],{117:function(e,t,n){"use strict";n.d(t,"a",(function(){return p})),n.d(t,"b",(function(){return b}));var i=n(0),l=n.n(i);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,i,l=function(e,t){if(null==e)return{};var n,i,l={},r=Object.keys(e);for(i=0;i<r.length;i++)n=r[i],t.indexOf(n)>=0||(l[n]=e[n]);return l}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(i=0;i<r.length;i++)n=r[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(l[n]=e[n])}return l}var u=l.a.createContext({}),s=function(e){var t=l.a.useContext(u),n=t;return e&&(n="function"==typeof e?e(t):a(a({},t),e)),n},p=function(e){var t=s(e.components);return l.a.createElement(u.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return l.a.createElement(l.a.Fragment,{},t)}},y=l.a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,o=e.parentName,u=c(e,["components","mdxType","originalType","parentName"]),p=s(n),y=i,b=p["".concat(o,".").concat(y)]||p[y]||d[y]||r;return n?l.a.createElement(b,a(a({ref:t},u),{},{components:n})):l.a.createElement(b,a({ref:t},u))}));function b(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=y;var a={};for(var c in t)hasOwnProperty.call(t,c)&&(a[c]=t[c]);a.originalType=e,a.mdxType="string"==typeof e?e:i,o[1]=a;for(var u=2;u<r;u++)o[u]=n[u];return l.a.createElement.apply(null,o)}return l.a.createElement.apply(null,n)}y.displayName="MDXCreateElement"},72:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return o})),n.d(t,"metadata",(function(){return a})),n.d(t,"toc",(function(){return c})),n.d(t,"default",(function(){return s}));var i=n(3),l=n(7),r=(n(0),n(117)),o={id:"pool-tx",sidebar_label:"Pool",title:"Pool transaction structure"},a={unversionedId:"tx-script/pool-tx",id:"tx-script/pool-tx",isDocsHomePage:!1,title:"Pool transaction structure",description:"In pool page\uff0cwhen Liquidity Providers\uff08LPs) mananger their liquidity, 5 types of transaction may be involved:",source:"@site/docs/tx-script/pool-tx.md",slug:"/tx-script/pool-tx",permalink:"/gliaswap-docs/docs/tx-script/pool-tx",editUrl:"https://github.com/facebook/docusaurus/edit/master/website/docs/tx-script/pool-tx.md",version:"current",sidebar_label:"Pool",sidebar:"docs",previous:{title:"Swap Transaction Structure",permalink:"/gliaswap-docs/docs/tx-script/swap-tx"},next:{title:"Info Cell Type Script",permalink:"/gliaswap-docs/docs/tx-script/info-type-script"}},c=[{value:"1. Creat a pool",id:"1-creat-a-pool",children:[{value:"Info type script - rule 4",id:"info-type-script---rule-4",children:[]}]},{value:"2. LPs submit add liquidity request",id:"2-lps-submit-add-liquidity-request",children:[]},{value:"3. LPs submit remove liquidity request",id:"3-lps-submit-remove-liquidity-request",children:[]},{value:"4. Aggregators match liquidity request with pool",id:"4-aggregators-match-liquidity-request-with-pool",children:[{value:"Info type script - rule 5/rule6/rule7",id:"info-type-script---rule-5rule6rule7",children:[]},{value:"Info lock script - rule 1",id:"info-lock-script---rule-1",children:[]},{value:"Liquidity request lock script - rule 1",id:"liquidity-request-lock-script---rule-1",children:[]},{value:"sUDT type script",id:"sudt-type-script",children:[]}]},{value:"5. LPs can cancel their own liquidity request",id:"5-lps-can-cancel-their-own-liquidity-request",children:[{value:"Liquidity request lock script - rule 2",id:"liquidity-request-lock-script---rule-2",children:[]}]}],u={toc:c};function s(e){var t=e.components,n=Object(l.a)(e,["components"]);return Object(r.b)("wrapper",Object(i.a)({},u,n,{components:t,mdxType:"MDXLayout"}),Object(r.b)("p",null,"In pool page\uff0cwhen Liquidity Providers\uff08LPs) mananger their liquidity, 5 types of transaction may be involved:"),Object(r.b)("ol",null,Object(r.b)("li",{parentName:"ol"},"Anyone can creat a pool"),Object(r.b)("li",{parentName:"ol"},"Liquidity Providers\uff08LPs) submit add liquidity request"),Object(r.b)("li",{parentName:"ol"},"Liquidity Providers\uff08LPs) submit remove liquidity request"),Object(r.b)("li",{parentName:"ol"},"Aggregators match liquidity request with pool to help LP to manager their liquidity sucessfully"),Object(r.b)("li",{parentName:"ol"},"Liquidity Providers\uff08LPs) cancel liquidity request")),Object(r.b)("h2",{id:"1-creat-a-pool"},"1. Creat a pool"),Object(r.b)("p",null,"Creat a pool in Gliaswap is permissionless. In the first version, Gliaswap only support to creat sudt/CKB pool. "),Object(r.b)("p",null,"Creat a pool actually is to creat two cell: "),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"info cell used to store pool info, including reserve balance, Liquidity token balance and other ID info to indentify the pool"),Object(r.b)("li",{parentName:"ul"},"pool cell used to store the real asset, including CKB and sudt")),Object(r.b)("pre",null,Object(r.b)("code",Object(i.a)({parentName:"pre"},{}),"Input\n    Alice cell\n        capacity\n            250 + 186 + tx fee\n        data\n            NONE\n        type\n            NONE\n        lock\n            Alice lock\n        \nOutput\n    Info cell\n        capacity: \n            250\n        data: \n            ckb_reserve: 0\n            sudt_reserve: 0\n            lp_token_balance: 0\n            lp_token_type_hash\n        type: \n            code: INFO_TYPE_CODE_HASH \n            args: type id \n        lock: \n            code: INFO_LOCK_CODE_HASH \n            args: hash(ckb | asset_sudt_type_hash) | info_type_hash \n                \n     Pool cell\n        capacity: \n            186\n        data: \n            sudt_amount: 0\n        type: \n            <sudt type> \n        lock: \n            <info cell lock> \n")),Object(r.b)("p",null,"In this transaction,  Only info type script will be run to verify the tx, which leads to the third validation rule of info type script"),Object(r.b)("h3",{id:"info-type-script---rule-4"},"Info type script - rule 4"),Object(r.b)("p",null,"Rule 4 - If this is a creating pool transaction, verify that the Pool cell is created at the same time as the Info cell, and that the data filled in info cell and pool cell are correct."),Object(r.b)("h2",{id:"2-lps-submit-add-liquidity-request"},"2. LPs submit add liquidity request"),Object(r.b)("p",null,"If a LP want to add liqidity to a pool, he/she needs to submit a add liquidity request firstly. For example\uff0cAlice want to add M CKB and N sUDT_A to pool:"),Object(r.b)("pre",null,Object(r.b)("code",Object(i.a)({parentName:"pre"},{}),"Input\n    Alice normal cell\n        capacity\n            <M + 142 + 142 + tx fee>\n        data\n            tokenA amount: N\n        type\n            <tokenA type>\n        lock\n            <user's lock>\n        \nOutput\n     Alice add liquidity request cell    \n        capacity: \n            <M + 142 + 142>\n        data: \n            sudt_amount: N\n        type: \n            <tokenA type>\n        lock:\n            code: LIQUIDITY_REQ_LOCK_CODE_HASH \n            args: user_lock_hash | version | sudtMin | ckbMin | info_type_hash_32 | 0 | 0 | // tip and tip fee are 0 in current version\n")),Object(r.b)("p",null,"Notice that this transaction only validates regular SUDT rules constrained in sudt type script."),Object(r.b)("h2",{id:"3-lps-submit-remove-liquidity-request"},"3. LPs submit remove liquidity request"),Object(r.b)("p",null,"If a LP want to remove liquidity from a pool, he/she needs to submit a remove liquidity request firstly. For example\uff0cBob want to burn L Liquidity token and withdraw the "),Object(r.b)("pre",null,Object(r.b)("code",Object(i.a)({parentName:"pre"},{}),"Input\n    Bob normal cell\n        capacity\n            <235 + tx fee>\n        data\n            Liquidity token amount: N\n        type\n            <Liquidity token type>\n        lock\n            <user's lock>\n        \nOutput\n     Bob remove liquidity request cell    \n        capacity: \n            235\n        data: \n            Liquidity token amount: L\n        type: \n            <Liquidity token type>\n        lock:\n            code: LIQUIDITY_REQ_LOCK_CODE_HASH \n            args: user_lock_hash | version | sudtMin | ckbMin | info_type_hash_32 | 0 | 0 | // tip and tip fee are 0 in current version\n")),Object(r.b)("p",null,"Notice that this transaction only validates regular SUDT rules constrained in sudt type script."),Object(r.b)("h2",{id:"4-aggregators-match-liquidity-request-with-pool"},"4. Aggregators match liquidity request with pool"),Object(r.b)("p",null,"Motivated by the Tip fee claimed in the liquidity request cell, aggregators will continually retrieve the liquidity request cells\uff08including add liquidity request and remove liquidity request\uff09 and the pool cells and then compete to match them off-chain and submit matching transactions."),Object(r.b)("pre",null,Object(r.b)("code",Object(i.a)({parentName:"pre"},{}),"Input\n    Info cell\n        capacity: \n            250\n        data: \n            ckb_reserve: X\n            sudt_reserve: Y\n            lp_token_balance: Z\n            lp_token_type_hash\n        type: \n            code: INFO_TYPE_CODE_HASH \n            args: type id \n        lock: \n            code: INFO_LOCK_CODE_HASH \n            args: hash(ckb | asset_sudt_type_hash) | info_type_hash \n                \n     Pool cell\n        capacity: \n            186 + X\n        data: \n            sudt_amount: Y\n        type: \n            <sudt type> \n        lock: \n            <info cell lock>  \n    \n     Deal-miner cell\n     \n     Bob remove liquidity request cell\n        capacity: \n            235\n        data: \n            Liquidity token amount: l\n        type: \n            <Liquidity token type>\n        lock:\n            code: LIQUIDITY_REQ_LOCK_CODE_HASH \n            args: user_lock_hash | version | sudtMin | ckbMin | info_type_hash_32 | 0 | 0 | // tip and tip fee are 0 in current version\n        \n     Alice add liquidity request cell    \n        capacity: \n            <M + 142 + 142>\n        data: \n            sudt_amount: N\n        type: \n            <tokenA type>\n        lock:\n            code: LIQUIDITY_REQ_LOCK_CODE_HASH \n            args: user_lock_hash | version | sudtMin | ckbMin | info_type_hash_32 | 0 | 0 | // tip and tip fee are 0 in current version\n            \nOutput\n    Info cell\n        capacity: \n            214\n        data: \n            ckb_reserve: X - l*X/L + M\n            sudt_reserve: Y - l*Y/L + N\n            LP_token_balance: L - l + M*L/X\n            LP_token_type_hash20\n        type: \n            code: Info_TYPE_CODE_HASH \n            args: type id \n        lock: \n            code: INFO_LOCK_CODE_HASH \n            args: hash(ckb | asset_sudt_type_hash) | info_type_hash20 \n                \n     Pool cell\n        capacity: \n            162 + X - l*X/L + M\n        data: \n            sudt_amount: Y - l*Y/L + N\n        type: \n            <sudt type> \n        lock: \n            <info cell lock> \n    \n     Deal-miner cell\n     \n     Bob normal cell\n        capacity: \n            184 + l*X/L\n        data: \n            sudt_amount: l*Y/L\n        type: \n            <sudt type>\n        lock:\n            <Bob normal lock>\n        \n     Alice Liquidity token cell    \n        capacity: \n            142\n        data: \n            sudt_amount: M*L/X\n        type: \n            <LP type>\n        lock:\n            <Alice normal lock>\n            \n     Alice change cell\n        capacity:\n            142\n        data:\n            sudt_amount: n \n        type\n            <sudtA_type>\n        lock\n            <Alice normal lock>\n")),Object(r.b)("p",null,"In this transaction, four types of script will be run to verify the tx:"),Object(r.b)("h3",{id:"info-type-script---rule-5rule6rule7"},"Info type script - rule 5/rule6/rule7"),Object(r.b)("p",null,"Rule 5 - If this is a matching liquidity transaction, the cell sequence in this tx should follow the rules blow:"),Object(r.b)("pre",null,Object(r.b)("code",Object(i.a)({parentName:"pre"},{className:"language-text"}),"\ninfo_in_cell                            info_out_cell\npool_in_cell                            pool_out_cell\n                          -------\x3e\naggregator_in_cell                      aggregator_out_cell\n[remove_liquidity_request_cell]         [sudt_cell]\n[add_liquidity_request_cell]            [liquidity_cell + change_cell(sudt_cell or ckb_cell)]\n\n")),Object(r.b)("p",null,"Rules 6 - If this is initially adding liquidity, verify if minting the correct amount Liquidity token for user, and verify if the data storaged in info cell and pool cell is correct."),Object(r.b)("p",null,"Rule 7 - If this is not initially adding liquidity, iterate through all request cell"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"If it is add liquidity request cell, verify if minting the correct amount Liquidity token for user, and add up the CKB amount, sUDT amount and Liquidity token amount for verifying info cell and pool cell later."),Object(r.b)("li",{parentName:"ul"},"If it is remove liquidity request cell, verify if withdraw the correct CKB amount and sudt amount for user, and add up the CKB amount, sUDT amount and Liquidity token amount for verifying info cell and pool cell later."),Object(r.b)("li",{parentName:"ul"},"Verify if the data storaged in info cell and pool cell is correct")),Object(r.b)("h3",{id:"info-lock-script---rule-1"},"Info lock script - rule 1"),Object(r.b)("p",null,"Rules 1 - Verify if lock.args is consistent with info type"),Object(r.b)("h3",{id:"liquidity-request-lock-script---rule-1"},"Liquidity request lock script - rule 1"),Object(r.b)("p",null,"Rule 1 - verifity input index","[1]"," is info cell"),Object(r.b)("h3",{id:"sudt-type-script"},"sUDT type script"),Object(r.b)("p",null,Object(r.b)("a",Object(i.a)({parentName:"p"},{href:"https://talk.nervos.org/t/rfc-simple-udt-draft-spec/4333"}),"sUDT proposal")),Object(r.b)("h2",{id:"5-lps-can-cancel-their-own-liquidity-request"},"5. LPs can cancel their own liquidity request"),Object(r.b)("p",null,"Normally your will add liquidity or remove liquidity successfully soon after you submit the liquidity request, but if the price fluctuates above the slippage, your request will be pending until the pool price fluctuates back to the price you submitted."),Object(r.b)("p",null,"So we provide the cancel option for LPs. LPs can send a transaction to cancel their own liquidity request."),Object(r.b)("p",null,"For example, if Bob want to cancel his remove liqidity request:"),Object(r.b)("pre",null,Object(r.b)("code",Object(i.a)({parentName:"pre"},{}),"Input\n     Bob remove liquidity request cell    \n        capacity: \n            235\n        data: \n            Liquidity token amount: L\n        type: \n            <Liquidity token type>\n        lock:\n            code: LIQUIDITY_REQ_LOCK_CODE_HASH \n            args: user_lock_hash | version | sudtMin | ckbMin | info_type_hash_32 | 0 | 0 | // tip and tip fee are 0 in current version\n\n    Bob normal cell (used to pay the tx fee)\n        \nOutput\n    Bob normal cell\n        capacity\n            <235>\n        data\n            Liquidity token amount: N\n        type\n            <Liquidity token type>\n        lock\n            <user's lock>\n\n")),Object(r.b)("p",null,"This transaction leads to another rule of LIQUIDITY_REQ_LOCK"),Object(r.b)("h3",{id:"liquidity-request-lock-script---rule-2"},"Liquidity request lock script - rule 2"),Object(r.b)("p",null,"Rule 2 - If one of input cell in the transaction use user's lock specified in liquidity request cell args and the corresponding witness is not 0, unlock the request cell directly."))}s.isMDXComponent=!0}}]);